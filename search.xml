<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>工作日记(四)</title>
      <link href="/2024/03/24/%E9%A1%B9%E7%9B%AE%E6%97%A5%E8%AE%B0four/"/>
      <url>/2024/03/24/%E9%A1%B9%E7%9B%AE%E6%97%A5%E8%AE%B0four/</url>
      
        <content type="html"><![CDATA[<p>对上次的项目收尾进行一个思考。周一上班的时候，虽然木马还在正常回连，但是域管理员组的密码已经被批量更改了，而且部门机器上出现了新的杀软，甚至还有卡巴斯基企业EDR，木马没被干掉还能连回来纯属运气。</p><p>所以我在想，目前这么多防御杀软EDR，各家特点也不一样，规则查杀点也不一样。在不能对其进行RCE之前，我无从得知我即将面对的到底是什么AV，也无从得知后续万一惊扰到目标，目标会动用什么杀软来防御和查杀。</p><p>思来想去，比如卡巴斯基这类，他们会自动把可疑样本提交上传的，内部也会有专门人员对木马进行调试，而且要规避不用的EDR还得都大概了解他们的查杀规则，需要有丰富的测试经验，这个我目前无法入手，因为这类EDR搞不到，而且还是指不定这边没杀，那边就被杀了，这会儿没杀，等会儿就被杀了。</p><p>我觉得单纯的对木马做免杀实属路走窄了，吃力不讨好，在内网横向移动的过程其实普遍都上去就是高权限，那为什么不加载个驱动去保护自己的木马不被干掉呢？</p><p>所以我准备未来的一段时间就研究这个方向了，因为目前碰到最大的问题，还是免杀维权的问题。</p>]]></content>
      
      
      <categories>
          
          <category> 立的flag </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 项目日记 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>工作日记(一)</title>
      <link href="/2024/03/19/%E9%A1%B9%E7%9B%AE%E6%97%A5%E8%AE%B0one/"/>
      <url>/2024/03/19/%E9%A1%B9%E7%9B%AE%E6%97%A5%E8%AE%B0one/</url>
      
        <content type="html"><![CDATA[<p>对最近项目过程实施，经验总结一下，首先描述一下攻击路径以及情况：</p><p>​占了同事的光，在外网获取到一个SQL注入的点，他转交给我了。MSSQL的注入，我尝试SQLMAP梭哈了，却是没跑出来，我查看漏洞验证的报文，且手工尝试后发现很明显也很简单的，而且还存在堆叠，但是SQLMAP为什么没跑出来呢？手工对payload进行编码，调试后，开启xp_cmd进行RCE成功了，获取到了初始访问权限，大概是SQLMAP自动注入的时候编码有问题。</p><p>​枚举本地进程发现杀软Windows Defener，制作木马落地上线，因为本就是MSSQL服务账户的权限，可以直接用土豆提system的，但是在提的过程中马被Defener给杀了，beacon掉了，但是无所谓，又点了一下在提权后自动执行defener加白操作。把初始入口马给稳固了。然后发现了内网环境，发现了域环境。开始先留马做了维权。</p><p>​权限维持估摸着差不多，开始实施后渗透，Mimikatz抓密码直接抓到了域管的NTLM，然后定位域控，起隧道，至此还蛮顺利的，与控股5985没开，走Psexec尝试横向域控的时候，发现不太对劲，链接445，135超时，就直接走Smbexec上去，Smbexec这东西好处是只用走445，且是system权限，但是无法更改当前目录很难受。在上边查看进程时候发现了卡巴斯基，那就不奇怪了。</p><p>​至此细想了一下域管hash在手，域控似乎暂时没什么必要上去，开始找邮服，起了八怪的就是邮服死活摸不到，就像这目标不用邮服一样，那怎么可能呢？大概率是因为语言不通看不懂，误打误撞摸到了文服，里边一堆个人文件共享，也不知道哪些有价值，看了下能出网，就先点了留了马。</p><p>​邮服死活没找到，捎带着把内网情况捋顺了，摸到了大概率内网办公个人PC段，准备上去抓浏览器记录找邮服的，横一台就发现了卡巴斯基，横一台就发现了卡巴斯基，桌面也没找到什么密码本，有一台名为admin的PC机，尝试横过，发现445失败了，那台是脱域的。不断的横向去看这台机器的当前用户，也从域组域用户里去筛选可能手握实权的高价值目标。但是最后发现他们似乎真的不不用邮服，或者邮服不在内网里，在其他第三方托管，每台机器上都有一种聊天软件。似乎类似于企业微信。</p><p>​在有天晚上掐着时间点，估摸着他们应该是下班了。准备走RDP强登上去看他们的聊天软件里有没有什么，桌面里有没有什么。登上去还没来得及看，就看到桌面下边有卡巴，又被顶下去了。就刚刚赶好差了那么一丢丢运气。最后又尝试了登了一台，发现桌面也没什么东西，邮服死活就是找不到，最后把邮服放弃了，而且目标似乎也警觉知道有人进来了，后续木马出现了掉线情况。</p><p>关于经验的总结：</p><p>​1.效率较慢，行动周期较长，可能也是因为刚上手这类项目，经验不足以让思路更灵活一些。</p><p>​2.免杀，免杀是个大问题，虽然木马在小组里有人专门做，但是每次都是现需要现做，木马经常本地测试了说正常，还搞了一堆分离什么的，传过去麻烦的要死，点了还连不回来。这是整个项目过程中我觉得最影响效率的了。自己的免杀我是没信心过卡巴EDR。登录个人机能看到是卡巴企业EDR，且有卡巴控制台的ip地址，但是登录上去企业面板不知道怎么加白下发策略。似乎就是木马免杀不太明显惊动目标了。所以今后可能得抽点时间提升自己的免杀技能，得随用随有。</p><p>​3.个人浏览器数据其中密码是加密的，但是我不会解，且目标上有卡巴mimikatz也上不去，目前唯一的依仗就是C2插件一键提取，但是木马经常出问题，所以被迫一台一台手动导浏览器信息，但是密码我不会解，后续这方面也得学习一下。</p>]]></content>
      
      
      <categories>
          
          <category> 立的flag </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 项目日记 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>工作日记(三)</title>
      <link href="/2024/03/19/%E9%A1%B9%E7%9B%AE%E6%97%A5%E8%AE%B0three/"/>
      <url>/2024/03/19/%E9%A1%B9%E7%9B%AE%E6%97%A5%E8%AE%B0three/</url>
      
        <content type="html"><![CDATA[<p>对最近的实施项目做一个回溯总结：</p><p>​首先入口是通过weblogic批量梭哈出来的，获取初始访问立足点后是极其难受的，因为入口一台linux机器各种环境问题，导致工具各种报错跑不起来。且本地枚举什么有价值的信息都没有。隧道代理还是走的neo http脚本隧道。难受buff叠满！</p><p>​换了个老版本的fscan传了一午休的功夫，开始扫C段，web服务都是一些404，且看端口状甚至半天没看到台windows。弱口令也一个都没扫出来，不过好在运气好，摸到一台win7，还摸到了一台xp。两个都有MS17-010，首先打了那台win7，找poc，Metasploit都试过了，各种插件也试过，都失败了，最后又用fscan梭哈了一下B段常用端口，没敢扫全端口，还是一无所获，且摸到了卡巴控制台的web页面。当时寻思着失败是不是卡巴给拦了，但是这东西当下也不知道怎么绕，最后用方程式的工具打成功了，上边有个用户正在活跃的，把cmd替换了shift，rdp界面呼出来控制，没办法调分辨率！字贼小！及其的难受！查看进程根本没发现卡巴，但是永恒之蓝为什么打不成功了？</p><p>​32位的win7，上边有个桌面用户每天还在照常办公，是在域环境里，传入mimikatz抓了密码Hash。但是没有域用户的凭证！遍历目录也没发现其他有价值的东西。然后转头用方程式工具去摸了那台xp的永恒之蓝，也成功了，上边目录据多，疑似个备份服务器。该机器不在域里，最后又摸了半天一无所获，实在没法子了，拿着为数不多的hash去对着扫出来的B段Windows机器本地管理员密码碰撞，然后摸到台win10，Win10上边没卡巴，只有defener，但是win10不在域里，目录也没翻到密码文件敏感信息。但是好处是能出网，可以改善一下隧道环境，但是没想着起隧道了，因为当时觉得这个内网环境没什么摸索的必要性了。抓了密码后接着喷洒，然后碰撞出了卡巴控制台所属服务器的本地管理员，而且卡巴服务控制台扫445是能发现在域里的。</p><p>​出乎意料的是卡巴控制台服务器上并没有部署卡巴，还是Defener，但是如我所料的，上边有域管理组的用户hash。且卡巴控制台机器能出网的，就也留了维权措施，然后横到了域控上，发现也是个Defener，加白传mimikatz转储了hash。域控有三台，分别留了马。但是一样的在内网邮服没找到，文服没找到，就连数据库都只摸到一台。</p><p>​本来想着就到此为止了，为了图省事在域控上边直接跑了Bloodhound，拖回来打开发现了另一个信任域，先查看了一下网络情况确定是能通的，但是对对方域一无所知，而且只能通域控。当时看了一眼时区，估摸着对方大概率现在没在上班，就直接Bloodhound远程枚举了一下，然后人都傻了，生成的结果的压缩包有近1M的大小。导入Bloodhound，大几千的用户，大几千的PC。域管理员就几十多个，心里都咯噔一下，想着这是什么庞然大物。</p><p>​枚举了域信任发现有SID过滤，但也尝试了两次，发现目标上边疑似有杀软防护，因为尝试之后会被单方面拉黑一会儿。开始分析Bloodhound，发现另一个域下还有一个子域。父子域的双向信任，还有我当前域跨域的双向信任。首先我找了森林用户，森林组，Bloodhound显示都是0，但是有一个森林管理员的用户账户，它对我当前域内一台机器有Admin to的权限，我就寻思着，“那你是不是登过呀？”我就横向到了那台机器，win7 x32，抓了mimikatz没有发现密码。纳闷半天又开始分析Bloodhound，发现了两个禁用预认证的用户，尝试As-REP roasting获取hash破解密码没破解出来。然后发现As-REP roasting的用户现在可以紧接着去kerberroasting，在bloodhound里复制出了一堆SPN，尝试Kerberroasting后hash还是一个都没破解出来。然后开始衡量目标内网机器，发现邮服，文服，数据库，极其的诱人。然后利用Bloodhound发现低版本的老旧操作系统，例如win 7 、xp 、2008等，枚举筛选了大几十台去批量扫POC，发现一个都没有。</p><p>​开摆！准备去搜集一些高价值用户组，开始核对，有没有域内用户名相似的高价值用户，看密码能不能复用碰撞。然后还真逮到一个！可以直接登域控，在上边发现了其他域管的会话。杀软还是defener，但是没权限加白，System都没权限加白，这个Defener似乎不太一样，且当时看时差，目标应该已经上班了，会话也是活动的。就在想要不远程导出一下hash？准备开始整的时候发现自己像个傻缺。平白无故搞那么多流量生怕不被发现一样。创建卷影副本直接导了。</p><p>​导了之后开始寻思着怎么进入目标域里，目前只能通域控，其他机器都不通的。算着他们时差估摸着没人的时候，尝试做了免杀马丢到了域控上，走代理开始摸域内机器，同事直接RDP莽上去了，迎面弹出一个不知名EDR还是XDR。没法退，压根就没有退出的按钮，进程也杀不掉。记住了进程名后去核对自己之前有些机器上也发现了该AV的存在。</p><p>​那登都登了，被发现也没辙，只能尽快横向其他机器稳固维持好权限。发现了一台没有部署该AV甚至没有杀软的。转交给同事去做代理好拿邮服。自己接着去找机器留马做维权。大概率是有些告警惊扰了管理员，几十个管理员这怕是分分钟钟被赶出去。马上就发现域管理员密码被改了，且同事的RDP也开始有人顶。遂感大事不妙，主域登不上去了。又去导出的hash里找了一个管理员登上了DC03，卷影副本直接重新转储了一遍hash拖了回去。马也开始在最开始的域里留了。尽力了，点还能不能控的住随缘了。</p><p>本次项目的实施倒是体验的非常丰富精彩，唯一美中不足就是还是多少引起目标警觉了。不过好在风头似乎还行，这片回溯文章写于周末双休，刚刚上去看了一下发现留的马还是可以正常回连。</p>]]></content>
      
      
      <categories>
          
          <category> 立的flag </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 项目日记 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>工作日记(二)</title>
      <link href="/2024/03/19/%E9%A1%B9%E7%9B%AE%E6%97%A5%E8%AE%B0two/"/>
      <url>/2024/03/19/%E9%A1%B9%E7%9B%AE%E6%97%A5%E8%AE%B0two/</url>
      
        <content type="html"><![CDATA[<p>对近期所实施的项目做一下总结回溯，大概攻击路径是这样的：</p><p>​外网边缘资产通过log4j获取初始访问立足点，还是台windows。枚举本地进程后发现趋势科技。等专门搞马的同事拿了免杀马，上线了，但是权限也不敢提，就在翻文件看记录，看脚本有没有什么密码本。发现了域环境。可惜的是什么都没翻到，实在没什么空间了，服务账户，利用C2插件直接提到system。</p><p>​获取system权限后又开始翻管理员的目录，高权限用户的目录，一样的没有发现密码本什么的。因为当前目标有没有具体价值都还不确定，所以就没想着种键盘记录。用github上找了一个mini版本的dump hash工具，本地发现能过，就直接扔上去抓了下密码。抓了密码后在hash里发现了一些后缀admin的用户，不在域管组里，有趋势科技也没敢放PowerView那些去枚举，就挑着域机器名字差不多的，比如用户名是Vdi-admin，就挑着机器名里疑似VDI的去横，然后遍历进程，基本每台都有趋势科技，期间摸到一台上边有域管理组成员的目录，还摸到一台没看到趋势科技的。然后通过域管账户去验证发现能行，就开始导出域内信息，分析内网环境，摸到了文服，截至目前还是比较顺利的。</p><p>​意外还是出在邮服上，邮服他们似乎用的上级的，而且域控导出来的hash似乎是不能用的。尝试了几个都不对。所以还是得去找个人机去抓浏览器的密码，但是浏览器的密码不会解，所以尬住了。</p><p>​本次项目的实施大体顺利，主要还是浏览器数据密码不会解，后续得找个时间把该问题解决一下。</p>]]></content>
      
      
      <categories>
          
          <category> 立的flag </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 项目日记 </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>
